<template>
    <div id="app" class="app">
        <alert-success :text="success"/>
        <div class="title">Контроль причин необученности сотрудников</div>
        <div class="container">
            <select-item
                :style="{'max-width': '65%', display: 'inline-block'}"
                placeholder="Введите учебную программу"
                :items="itemsProgramm"
                :selectedItem="selectedProgramm"
                :save="selectProgramm"
                :preload="getProgramms"
                :loading="programmsLoading"
                :isRequired="true"/>
            <check-box  text="Показывать только с просрочкой" :value="withDelay" :action="changeDelay"/>
            <multi-select-items
                :style="{'max-width': '65%', display: 'inline-block'}"
                placeholder="Введите регион"
                :items="itemsRegion"
                :selectedItems="selectedRegions"
                :save="selectRegion"
                :preload="getRegions"
                :loading="regionsLoading"
                :remove="removeRegion"/>
            <check-box text="Показывать только с неуказанной причиной" :value="withoutReason" :action="changeReason"/><br/>
            <custom-button text="Показать сотрудников" :action="getCollabs" :loading="collabsLoading" :disabled="programmEmpty"/>
            <alert-warning :text="error" :close="closeError"/>
            <transition name="items">
                <ul class="container__collabs-list" v-show="collabs.length > 0 && !collabsLoading">
                    <li v-for="collab in collabsWithoutReason" :class="{ 'collabs-list__item-entered': collab.isEntered, 'collabs-list__item': true }">
                        <div :style="{width: 100 / 3 + '%', display: 'inline-block', margin: '8px 0', 'text-align': 'left', 'box-sizing': 'border-box', 'padding-left': '8px'}">
                            <a
                                :href="'http://study.merlion.ru/view_doc.html?mode=collaborator&object_id=' + collab.person_id"
                                target="_blank"
                                :style="{'text-decoration': 'none', cursor: 'pointer', color: 'inherit'}">
                                {{collab.info.name}}
                            </a>
                        </div>
                        <div :style="{width: 100 / 3 - 1 + '%', display: 'inline-block', margin: '8px 0'}">
                            {{collab.info.delay}}
                        </div>
                        <div :style="{width: 100 / 3 + '%', display: 'inline-block', margin: '8px 0'}">
                            <enter-reason-button
                                :text="collab.info.reason != '' || collab.isEntered ? 'Обновить причину' : 'Указать причину'"
                                :oldReason="collab.info.reason"
                                :adaptId="collab.id"
                                :action="openCommentWindow"/>
                        </div>
                    </li>
                </ul>
            </transition>
        </div>
        <transition name="modal">
            <div class="modal" v-show="enterComment">
                <div class="modal__enter-comment">
                    <div class="modal__enter-comment__title">
                        Укажите причину
                        <button class="close-button" @click="closeCommentWindow">&times;</button>
                    </div>
                    <div class="modal__enter-comment__container">
                        <textarea readonly v-for="reason in splitReasons" v-show="reason != ''" :value="reason.trim()" class="textarea-readonly" title="Старые причины"></textarea>
                        <textarea v-model="reason" autofocus="true" class="textarea-input" placeholder="Напишите причину"></textarea>
                        <custom-button text="Внести причину" :action="enterReason" :disabled="reason.trim() == ''"/>
                    </div>
                </div>
            </div>
        </transition>
    </div>
</template>

<script>
import MultiSelectItems from "./components/MultiSelectItems"
import SelectItem from "./components/SelectItem"
import CustomButton from "./components/CustomButton"
import EnterReasonButton from "./components/special/EnterReasonButton"
import AlertWarning from "./components/AlertWarning"
import AlertSuccess from "./components/AlertSuccess"
import CheckBox from "./components/CheckBox"
import _ from "lodash"
import { mapState, mapMutations, mapActions, mapGetters } from "vuex"

export default {
    name: "app",
    data () {
        return {
            enterComment: false,
            reason: ""
        }
    },
    computed: {
        ...mapState([
            "selectedProgramm",
            "itemsProgramm",
            "selectedRegions",
            "itemsRegion",
            "error",
            "success",
            "collabs",
            "oldReason",
            "collabsLoading",
            "regionsLoading",
            "programmsLoading",
            "withDelay",
            "withoutReason"
        ]),

        ...mapGetters([
            "splitReasons",
            "collabsWithoutReason"
        ]),

        programmEmpty () {
            return _.isEqual(this.selectedProgramm, {})
        }
    },
    methods: {
        ...mapMutations([
            "selectProgramm",
            "selectRegion",
            "closeError",
            "getSuccess",
            "changeReason",
            "changeDelay",
            "removeRegion"
        ]),

        ...mapActions([
            "getProgramms",
            "getRegions",
            "getCollabs",
            "postReason"
        ]),

        openCommentWindow () {
            this.enterComment = true
        },

        closeCommentWindow () {
            this.reason = ""
            this.enterComment = false
        },

        enterReason () {
            this.postReason(this.reason)
            this.enterComment = false
            this.reason = ""
        }
    },

    components: {
        SelectItem,
        CustomButton,
        AlertWarning,
        AlertSuccess,
        EnterReasonButton,
        CheckBox,
        MultiSelectItems
    }
}
</script>

<style src="./styles/styles.scss" lang="scss"></style>

<style lang="scss" scoped>
$font-color: #35495e;

.items-enter-active, .items-leave-active {
    transition: all .5s ease-in-out;
    overflow: hidden !important;
}

.items-enter, .items-leave-to {
    max-height: 0px !important;
}

.container {
    padding: 8px;
    transition: max-height .8s ease-in-out;
    position: relative;

    .container__collabs-list {
        overflow: auto;
        list-style: none;
        padding: 0;
        width: 100%;
        background: #fff;
        color: $font-color;
        max-height: 460px;
        margin: 16px 0;

        .collabs-list__item {
            text-align: center;
            border: 0px;
            border-radius: 4px;

            &:hover {
                color: #fff;
                background-color: #20a0ff;
            }
        }

        .collabs-list__item-entered {
            color: #fff;
            background-color: #999;
        }
    }
}

.modal__enter-comment {
    width: 50%;
    background-color: #fff;
    margin: 20% auto;
    box-shadow: 2px 2px 10px 0 #646464;
    border-radius: 5px;
    border: 0;

    .modal__enter-comment__title {
        background-color: #646464;
        color: #fff;
        padding: 10px 0 10px 8px;
        font-size: 14px;
    }

    .modal__enter-comment__container {
        padding: 8px;

        .textarea-input {
            width: 100%;
            box-sizing: border-box;
            resize: none;
            outline: 0;
            border-radius: 4px;
            min-height: 150px;
            margin-bottom: 8px;
            font-family: sans-serif;
            overflow: hidden;
            border-width: 1px;
            border-color: #a9a9a9;
        }

        .textarea-readonly {
            width: 100%;
            box-sizing: border-box;
            resize: none;
            outline: 0;
            border-radius: 4px;
            margin-bottom: 8px;
            font-family: sans-serif;
            overflow: hidden;
            border-width: 1px;
            border-color: #a9a9a9;
        }
    }
}

</style>
